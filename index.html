<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AfterSchool Activities</title>
    <link rel="icon" href="./images/Website_Logo.png" type="image/png" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/e712731f30.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="app">
      <header>
        <h1 v-text="sitename" v-on:click="showLessons"></h1>
        <div v-if="showLesson">
          <input
            type="text"
            v-model="searchQuery"
            placeholder="Search lessons..."
            class="search-input"
          />
        </div>
        <button v-on:click="showCheckout" :disabled="cart.length === 0">
          {{cartItemCount}}
          <span class="fa-solid fa-cart-shopping"></span>
          Checkout
        </button>
      </header>
      <main>
        <div id="sort" v-if="showLesson">
          <label>Sort by:</label>
          <select v-model="sortBy.field">
            <option value="price">Price</option>
            <option value="spaces">Spaces Availability</option>
            <option value="location">Location</option>
            <option value="title">Title</option>
            <option value="rating">Rating</option>
          </select>

          <button @click="toggleSortOrder">
            Order: {{ sortBy.order === "asc" ? "Ascending" : "Descending" }}
          </button>
        </div>
        <div class="lesson-grid" v-if="showLesson">
          <div
            id="individual-lesson"
            v-for="lesson in filteredLessons"
            :key="lesson.id"
          >
            <figure>
              <img v-bind:src="lesson.image" alt="" />
            </figure>
            <h2 v-text="lesson.title"></h2>
            <p v-text="lesson.description"></p>
            <p>Price: {{lesson.price}}</p>
            <p>Location: {{lesson.location}}</p>
            <p>
              Available Inventory: {{lesson.availableInventory -
              cartCount(lesson.id)}}
            </p>
            <button v-on:click="addToCart(lesson)" v-if="canAddToCart(lesson)">
              Add to Cart
            </button>
            <button disabled="disabled" v-else>Add to cart</button>
            <span v-if="lesson.availableInventory === cartCount(lesson.id)"
              >All out!</span
            >
            <span v-else> Buy Now!</span>
            <div id="rating">
              <span v-for="n in lesson.rating">★</span>
              <span v-for="n in 5-lesson.rating">☆</span>
            </div>
          </div>
        </div>
        <div v-else>
          <h2
            v-text="orderPlaced ? 'ORDER CONFIRMATION' : 'CHECKOUT PAGE'"
            v-on:click="showLessons"
          ></h2>
          <!-- Cart Items Summary -->
          <div id="cart_summary" v-if="cart.length > 0">
            <h3 v-if="!orderPlaced">Your Cart:</h3>
            <ul class="cart-item-list">
              <li v-for="lessonId in uniqueCartItems" class="cart-item">
                <img :src="getLessonImage(lessonId)" alt="Lesson Image" />
                <div class="cart-item-info">
                  <span class="cart-item-title"
                    >{{ getLessonTitle(lessonId) }}</span
                  ><br />
                  <span class="cart-item-price"
                    >Price: {{ getLessonPrice(lessonId) }}</span
                  ><br />
                  <span class="cart-item-quantity"
                    >Quantity: {{ cartCount(lessonId) }}</span
                  >
                </div>
                <button
                  v-on:click="removeFromCart(lessonId)"
                  v-if="!orderPlaced"
                >
                  Remove
                </button>
              </li>
            </ul>
          </div>
          <div v-else v-on:click="lessonsPage()"></div>
          <div id="order_form" v-if="showOrderForm">
            <p>
              <strong>Full Name:</strong>
              <input
                v-model.trim="order.fullName"
                @input="order.fullName = order.fullName.replace(/[^a-zA-Z\s]/g, '')"
                type="text"
              />
            </p>
            <p>
              <strong>Phone Number:</strong>
              <input
                v-model.trim="order.phone"
                type="tel"
                pattern="[0-9]*"
                @input="order.phone = order.phone.replace(/[^0-9]/g, '')"
              />
            </p>
            <p>
              <strong>Country:</strong>
              <select v-model="order.country" class="form-control">
                <option v-for="country in countries" v-bind:value="country">
                  {{country}}
                </option>
              </select>
            </p>
            <p>
              <strong>City:</strong>
              <input
                v-model.trim="order.city"
                type="text"
                @input="order.city = order.city.replace(/[^a-zA-Z\s]/g, '')"
              />
            </p>
            <p>
              <strong>Address:</strong>
              <input v-model="order.address" />
            </p>
            <p>
              <strong>Zip/Postal Code:</strong>
              <input v-model.number="order.zip" type="number" />
            </p>
            <button v-on:click="submitForm" :disabled="!FormComplete">
              Place Order
            </button>
          </div>
        </div>
        <div v-if="showOrder">
          <p>Full Name: {{order.fullName}}</p>
          <p>Contact Number: {{order.phone}}</p>
          <p>Country: {{order.country}}</p>
          <p>City: {{order.city}}</p>
          <p>Address: {{order.address}}</p>
          <p>Zip/Postal Code: {{order.zip}}</p>
        </div>
      </main>
    </div>
    <script>
      var webstore = new Vue({
        el: "#app",
        data: {
          sitename: "AfterSchool Activities",
          showLesson: true,
          showOrder: false,
          showOrderForm: true,
          orderPlaced: false,
          lessons: [],
          orders: [],
          debounceTimeout: null,
          filteredLessons: [],
          sortBy: "price",
          cart: [],
          cartItemsDetails: [],
          searchQuery: "",
          order: {
            fullName: "",
            phone: "",
            address: "",
            city: "",
            zip: "",
          },
          countries: [
            "Afghanistan",
            "Albania",
            "Algeria",
            "Andorra",
            "Angola",
            "Antigua and Barbuda",
            "Argentina",
            "Armenia",
            "Australia",
            "Austria",
            "Azerbaijan",
            "Bahamas",
            "Bahrain",
            "Bangladesh",
            "Barbados",
            "Belarus",
            "Belgium",
            "Belize",
            "Benin",
            "Bhutan",
            "Bolivia",
            "Bosnia and Herzegovina",
            "Botswana",
            "Brazil",
            "Brunei",
            "Bulgaria",
            "Burkina Faso",
            "Burundi",
            "Cabo Verde",
            "Cambodia",
            "Cameroon",
            "Canada",
            "Central African Republic",
            "Chad",
            "Chile",
            "China",
            "Colombia",
            "Comoros",
            "Congo",
            "Costa Rica",
            "Croatia",
            "Cuba",
            "Cyprus",
            "Czech Republic",
            "Democratic Republic of the Congo",
            "Denmark",
            "Djibouti",
            "Dominica",
            "Dominican Republic",
            "Ecuador",
            "Egypt",
            "El Salvador",
            "Equatorial Guinea",
            "Eritrea",
            "Estonia",
            "Eswatini",
            "Ethiopia",
            "Fiji",
            "Finland",
            "France",
            "Gabon",
            "Gambia",
            "Georgia",
            "Germany",
            "Ghana",
            "Greece",
            "Grenada",
            "Guatemala",
            "Guinea",
            "Guinea-Bissau",
            "Guyana",
            "Haiti",
            "Honduras",
            "Hungary",
            "Iceland",
            "India",
            "Indonesia",
            "Iran",
            "Iraq",
            "Ireland",
            "Israel",
            "Italy",
            "Jamaica",
            "Japan",
            "Jordan",
            "Kazakhstan",
            "Kenya",
            "Kiribati",
            "Korea, North",
            "Korea, South",
            "Kuwait",
            "Kyrgyzstan",
            "Laos",
            "Latvia",
            "Lebanon",
            "Lesotho",
            "Liberia",
            "Libya",
            "Liechtenstein",
            "Lithuania",
            "Luxembourg",
            "Madagascar",
            "Malawi",
            "Malaysia",
            "Maldives",
            "Mali",
            "Malta",
            "Marshall Islands",
            "Mauritania",
            "Mauritius",
            "Mexico",
            "Micronesia",
            "Moldova",
            "Monaco",
            "Mongolia",
            "Montenegro",
            "Morocco",
            "Mozambique",
            "Myanmar",
            "Namibia",
            "Nauru",
            "Nepal",
            "Netherlands",
            "New Zealand",
            "Nicaragua",
            "Niger",
            "Nigeria",
            "North Macedonia",
            "Norway",
            "Oman",
            "Pakistan",
            "Palau",
            "Palestine",
            "Panama",
            "Papua New Guinea",
            "Paraguay",
            "Peru",
            "Philippines",
            "Poland",
            "Portugal",
            "Qatar",
            "Romania",
            "Russia",
            "Rwanda",
            "Saint Kitts and Nevis",
            "Saint Lucia",
            "Saint Vincent and the Grenadines",
            "Samoa",
            "San Marino",
            "Sao Tome and Principe",
            "Saudi Arabia",
            "Senegal",
            "Serbia",
            "Seychelles",
            "Sierra Leone",
            "Singapore",
            "Slovakia",
            "Slovenia",
            "Solomon Islands",
            "Somalia",
            "South Africa",
            "South Sudan",
            "Spain",
            "Sri Lanka",
            "Sudan",
            "Suriname",
            "Sweden",
            "Switzerland",
            "Syria",
            "Taiwan",
            "Tajikistan",
            "Tanzania",
            "Thailand",
            "Timor-Leste",
            "Togo",
            "Tonga",
            "Trinidad and Tobago",
            "Tunisia",
            "Turkey",
            "Turkmenistan",
            "Tuvalu",
            "Uganda",
            "Ukraine",
            "United Arab Emirates",
            "United Kingdom",
            "United States",
            "Uruguay",
            "Uzbekistan",
            "Vanuatu",
            "Vatican City",
            "Venezuela",
            "Vietnam",
            "Yemen",
            "Zambia",
            "Zimbabwe",
          ],
        },
        created() {
          fetch("http://localhost:3000/AfterSchoolActivities/lessons", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((responseJSON) => {
              console.log("Response received:", responseJSON);
              this.lessons = responseJSON;
              this.filteredLessons = responseJSON;
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        },
        mounted() {
          if (this.cartIsEmpty) {
            this.showLessons();
          }
        },
        watch: {
          searchQuery(newQuery) {
            this.fetchFilteredLessons(newQuery);
          },
        },
        methods: {
          showLessons() {
            this.showLesson = true;
          },
          addToCart(lesson) {
            this.cart.push(lesson.id);
            const existingLesson = this.cartItemsDetails.find(
              (item) => item.id === lesson.id
            );

            if (existingLesson) {
              existingLesson.quantity++;
            } else {
              this.cartItemsDetails.push({
                id: lesson.id,
                title: lesson.title,
                price: lesson.price,
                quantity: 1,
                location: lesson.location,
              });
            }
          },
          canAddToCart(lesson) {
            return lesson.availableInventory > this.cartCount(lesson.id);
          },
          removeFromCart(lessonId) {
            const index = this.cart.lastIndexOf(lessonId);
            if (index > -1) {
              this.cart.splice(index, 1);
            }
            if (this.cart.length === 0) {
              this.showLesson = true;
            }
          },
          toggleSortOrder() {
            this.sortBy.order = this.sortBy.order === "asc" ? "desc" : "asc";
          },
          lessonsPage() {
            this.showLesson = this.showLesson ? false : true;
          },
          fetchFilteredLessons(query) {
            if (!query) {
              this.filteredLessons = [];
              return;
            }
            fetch(`/AfterSchoolActivities/search/${query}`)
              .then((response) => response.json())
              .then((lessons) => {
                this.filteredLessons = lessons;
              })
              .catch((error) => {
                console.error("Error fetching lessons:", error);
                this.filteredLessons = [];
              });
          },
          submitForm() {
            {
              this.showLesson = false;
              this.showOrder = true;
              this.showOrderForm = false;
              this.orderPlaced = true;
            }
            const orderDetails = {
              fullName: this.order.fullName,
              phone: this.order.phone,
              country: this.order.country,
              city: this.order.city,
              address: this.order.address,
              zip: this.order.zip,
              cartItems: this.cartItemsDetails,
            };
            fetch("http://localhost:3000/AfterSchoolActivities/orders", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(orderDetails),
            })
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
              })
              .then((responseJSON) => {
                console.log("Order saved successfully:", responseJSON);
                this.orderPlaced = true;
                this.updateInventoryAfterOrder(this.cartItemsDetails);
              })
              .catch((error) => {
                console.error("Error saving order:", error);
              });
          },
          updateInventoryAfterOrder(cartItems) {
            cartItems.forEach((item) => {
              fetch(
                `http://localhost:3000/AfterSchoolActivities/lessons/${item.id}`,
                {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    quantity: item.quantity,
                  }),
                }
              )
                .then((response) => {
                  if (!response.ok) {
                    throw new Error(
                      `Failed to update inventory for lesson ${item.id}`
                    );
                  }
                  return response.json();
                })
                .then((responseJSON) => {
                  console.log(
                    "Inventory updated for lesson:",
                    item.id,
                    "-",
                    item.title,
                    responseJSON
                  );
                })
                .catch((error) => {
                  console.error("Error updating inventory:", error);
                });
            });
          },
          cartCount(id) {
            let count = 0;
            for (let i = 0; i < this.cart.length; i++) {
              if (this.cart[i] === id) {
                count++;
              }
            }
            return count;
          },
          showCheckout() {
            this.showLesson = this.showLesson ? false : true;
          },
          getLessonTitle(lessonId) {
            const lesson = this.lessons.find((p) => p.id === lessonId);
            return lesson ? lesson.title : "Not a Lesson";
          },
          getLessonPrice(lessonId) {
            const lesson = this.lessons.find((p) => p.id === lessonId);
            return lesson ? lesson.price : "Not a Lesson";
          },
          getLessonImage(lessonId) {
            const lesson = this.lessons.find((p) => p.id === lessonId);
            return lesson ? lesson.image : "Lesson Image";
          },
        },
        computed: {
          cartItemCount: function () {
            return this.cart.length;
          },
          sortedLessons() {
            const spacesAvailable = (lesson) =>
              lesson.availableInventory - this.cartCount(lesson.id);

            const sortingFunctions = {
              price: (a, b) => a.price - b.price,
              spaces: (a, b) => spacesAvailable(a) - spacesAvailable(b),
              location: (a, b) => a.location.localeCompare(b.location),
              title: (a, b) => a.title.localeCompare(b.title),
              rating: (a, b) => a.rating - b.rating,
            };

            const sortFn = sortingFunctions[this.sortBy.field];
            const sorted = [...this.lessons].sort(sortFn);

            return this.sortBy.order === "asc" ? sorted : sorted.reverse();
          },
          uniqueCartItems() {
            return [...new Set(this.cart)]; //Set object removes all duplicate values so if a lesson is selected twice it won't appear twice with all the deets just one line with quantity set as 2
          },
          FormComplete() {
            return (
              this.order.fullName.trim() !== "" &&
              this.order.phone.trim() !== "" &&
              this.order.address.trim() !== "" &&
              this.order.city.trim() !== "" &&
              this.order.zip !== "" &&
              this.order.country !== ""
            );
          },
        },
      });
    </script>
  </body>
</html>